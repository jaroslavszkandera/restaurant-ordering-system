{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}Reservation - Pomodoro House{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/form.css">
<link rel="stylesheet" href="/static/css/table.css">
{% endblock %}

{% block content %}
<main class="container d-flex flex-column align-items-center justify-content-start" style="margin-top: 100px;">
  <div class="auth-container">
    <h1 class="mb-4 text-center">Reservation</h1>
    <hr style="width: 90%; border-top: 1px solid white ; margin: 0 auto 1rem auto;" />
    <form id="reservationForm" method="POST" action="{% url 'reservation' %}">
      {% csrf_token %}

      {% if error_message and request.method == 'POST' %}
        <div class="text-danger mb-3" style="font-size: 0.75rem;">Kindly review the details you’ve entered.</div>
      {% endif %}

      <!-- 用餐人數 -->
      <div class="mb-3">
        <label for="guests" class="form-label">Number of Guests</label>
        <select name="guests" id="guests" class="dropdown-original" style="display: none;" required>
          <option value="" disabled {% if not selected_guests %}selected{% endif %}>Select number of guests</option>
          {% for i in guest_range %}
            <option value="{{ i }}" {% if i|stringformat:"s" == selected_guests|stringformat:"s" %}selected{% endif %}>
              {{ i }} guests
            </option>
          {% endfor %}
        </select>
        <div class="dropdown" id="guestsDropdown"></div>
        {% if error_guests %}<small class="text-danger">{{ error_guests }}</small>{% endif %}
      </div>

      <!-- 用餐日期 -->
      <div class="mb-3">
        <label for="date" class="form-label">Reservation Date</label>
        <input 
          type="date" 
          name="date" 
          id="date" 
          class="form-control date-input" 
          min="{{ today|date:'Y-m-d' }}" 
          max="{{ two_months_later|date:'Y-m-d' }}" 
          value="{{ selected_date|date:'Y-m-d' }}" 
          required>
        {% if error_date %}
          <small class="text-danger d-block" style="font-size: 0.75rem;">{{ error_date }}</small>
        {% endif %}
      </div>

      <!-- 分店選擇 -->
      <div class="mb-3">
        <label for="branch" class="form-label">Branch</label>
        <select name="branch" id="branch" class="dropdown-original" style="display: none;" required>
          <option value="" disabled {% if not selected_branch_id %}selected{% endif %}>Select branch</option>
          {% for branch in branches %}
            {% with branch_availability|get_item:branch.id as avail %}
              {% if avail and not avail.disabled %}
                <option value="{{ branch.id }}"
                  {% if branch.id|stringformat:"s" == selected_branch_id|stringformat:"s" %}selected{% endif %}>
                  {{ branch.name }}
                </option>
              {% endif %}
            {% endwith %}
          {% endfor %}
        </select>
        <div class="dropdown" id="branchDropdown"></div>
        {% if error_branch %}<small class="text-danger">{{ error_branch }}</small>{% endif %}
      </div>

      <!-- 用餐時段 -->
      <div class="mb-3">
        <label for="time_slot" class="form-label">Time Slot</label>
        <select name="time_slot" id="time_slot" class="dropdown-original" style="display: none;" required>
          {% if available_time_slots %}
            {% for slot in available_time_slots %}
              <option value="{{ slot.time|time:'H:i' }}"
                {% if not slot.available %}disabled{% endif %}
                {% if slot.time|time:'H:i' == request.GET.time_slot %}selected{% endif %}>
                {{ slot.time_display }}
              </option>
            {% endfor %}
          {% else %}
            <option value="" disabled>No time slots configured</option>
          {% endif %}
        </select>
        <div class="dropdown" id="timeSlotDropdown"></div>
        {% if error_time_slot %}<small class="text-danger">{{ error_time_slot }}</small>{% endif %}
      </div>

      <!-- 姓名 -->
      <label for="id_name" class="form-label mb-1">Name <span class="text-white">*</span></label>
      <input type="text" id="id_name" name="name" class="form-control mb-1" value="{{ name|default:'' }}">
      {% if error_name %}
        <small class="text-danger d-block" style="font-size: 0.75rem;">{{ error_name }}</small>
      {% endif %}
      <small class="text-muted mb-3 d-block" style="font-size: 0.75rem;">Please enter your full name.</small>

      <!-- 手機 -->
      <label for="id_mobile" class="form-label mb-1">Mobile Phone <span class="text-white">*</span></label>
      <input type="tel" id="id_mobile" name="mobile" class="form-control mb-1" value="{{ mobile|default:'' }}">
      {% if error_mobile %}
        <small class="text-danger d-block" style="font-size: 0.75rem;">{{ error_mobile }}</small>
      {% endif %}
      <small class="text-muted mb-3 d-block" style="font-size: 0.75rem;">e.g., 0911222333.</small>

      <!-- Email -->
      <label for="id_email" class="form-label mb-1">Email <span class="text-white">*</span></label>
      <input type="text" id="id_email" name="email" class="form-control mb-1" value="{{ email|default:'' }}">
      {% if error_email %}
        <small class="text-danger d-block" style="font-size: 0.75rem;">{{ error_email }}</small>
      {% endif %}
      <small class="text-muted mb-3 d-block" style="font-size: 0.75rem;">
        Enter a valid email address including '@' and domain (e.g., user@example.com).
      </small>
      
      <!-- 提交按鈕 -->
      <button type="submit" class="btn custom-login-btn w-100">Submit Reservation</button>
    </form>
  </div>
</main>
{% endblock %}

{% block extra_js %}
<script src="/static/js/reservation.js"></script>
{% endblock %}