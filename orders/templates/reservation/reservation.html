{% extends 'base.html' %}
{% load custom_filters %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/form.css">
<link rel="stylesheet" href="/static/css/table.css">
{% endblock %}

{% block content %}
<main class="container d-flex flex-column align-items-center justify-content-start" style="margin-top: 100px;">
  <div class="auth-container">
    <h1 class="mb-4 text-center">Reservation</h1>
    <hr style="width: 90%; border-top: 1px solid white ; margin: 0 auto 1rem auto;" />
    <form id="reservationForm" method="POST" action="{% url 'reservation' %}">
      {% csrf_token %}

      {% if error_message and request.method == 'POST' %}
        <div class="text-danger mb-3" style="font-size: 0.75rem;">Kindly review the details you’ve entered.</div>
      {% endif %}

      <!-- 用餐人數 -->
      <div class="mb-3">
        <label for="guests" class="form-label">Number of Guests</label>
        <select name="guests" id="guests" class="form-control" required>
          <option value="" disabled {% if not selected_guests %}selected{% endif %}>Select number of guests</option>
          {% for i in guest_range %}
            <option value="{{ i }}" {% if i|stringformat:"s" == selected_guests|stringformat:"s" %}selected{% endif %}>
              {{ i }} guests
            </option>
          {% endfor %}
        </select>
        {% if error_guests %}<small class="text-danger d-block" style="font-size: 0.75rem;">{{ error_guests }}</small>{% endif %}
      </div>

      <!-- 用餐日期 -->
      <div class="mb-3">
        <label for="date" class="form-label">Reservation Date</label>
        <input 
          type="date" 
          name="date" 
          id="date" 
          class="form-control" 
          min="{{ today|date:'Y-m-d' }}" 
          max="{{ two_months_later|date:'Y-m-d' }}" 
          value="{{ selected_date|date:'Y-m-d' }}" 
          required>
        {% if error_date %}
          <small class="text-danger d-block" style="font-size: 0.75rem;">{{ error_date }}</small>
        {% endif %}
      </div>

      <!-- 分店選擇 -->
      <div class="mb-3">
        <label for="branch" class="form-label">Branch</label>
        <select name="branch" id="branch" class="form-control" required>
          <option value="" disabled {% if not selected_branch_id %}selected{% endif %}>Select branch</option>
          {% for branch in branches %}
            {% with branch_availability|get_item:branch.id as avail %}
              {% if avail and not avail.disabled %}
              <option value="{{ branch.id }}"
                {% if branch.id|stringformat:"s" == selected_branch_id|stringformat:"s" %}selected{% endif %}>
                {{ branch.name }}
              </option>
              {% endif %}
            {% endwith %}
          {% endfor %}
        </select>
        {% if error_branch %}<small class="text-danger d-block" style="font-size: 0.75rem;">{{ error_branch }}</small>{% endif %}
      </div>

      <!-- 用餐時段 -->
      <div class="mb-3">
        <label for="time_slot" class="form-label">Time Slot</label>
        <select name="time_slot" id="time_slot" class="form-control" required>
          {% if available_time_slots %}
            {% for slot in available_time_slots %}
              <option value="{{ slot.time|time:"H:i" }}"
                {% if not slot.available %}disabled style="color:gray;"{% endif %}
                {% if slot.time|time:"H:i" == request.GET.time_slot %}selected{% endif %}>
                {{ slot.time_display }} 
              </option>
            {% endfor %}
          {% else %}
            <option value="" disabled>No time slots configured</option>
          {% endif %}
        </select>
        {% if error_time_slot %}
          <small class="text-danger d-block" style="font-size: 0.75rem;">{{ error_time_slot }}</small>
        {% endif %}
      </div>

      <!-- 姓名 -->
      <label for="id_name" class="form-label mb-1">Name <span class="text-white">*</span></label>
      <input type="text" id="id_name" name="name" class="form-control mb-1" value="{{ name|default:'' }}">
      {% if error_name %}
        <small class="text-danger d-block" style="font-size: 0.75rem;">{{ error_name }}</small>
      {% endif %}
      <small class="text-muted mb-3 d-block" style="font-size: 0.75rem;">Please enter your full name.</small>

      <!-- 手機 -->
      <label for="id_mobile" class="form-label mb-1">Mobile Phone <span class="text-white">*</span></label>
      <input type="tel" id="id_mobile" name="mobile" class="form-control mb-1" value="{{ mobile|default:'' }}">
      {% if error_mobile %}
        <small class="text-danger d-block" style="font-size: 0.75rem;">{{ error_mobile }}</small>
      {% endif %}
      <small class="text-muted mb-3 d-block" style="font-size: 0.75rem;">e.g., 0911222333.</small>

      <!-- 提交按鈕 -->
      <button type="submit" class="btn custom-login-btn w-100">Submit Reservation</button>
    </form>
  </div>
</main>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const guestsInput = document.getElementById('guests');
    const dateInput = document.getElementById('date');
    const branchInput = document.getElementById('branch');
    const timeSlotSelect = document.getElementById('time_slot');

    async function updateTimeSlots() {
      const guests = guestsInput.value;
      const date = dateInput.value;
      const branch = branchInput.value;

      // 顯示 loading 狀態
      timeSlotSelect.innerHTML = `<option disabled selected>Loading...</option>`;
      timeSlotSelect.value = '';

      if (!guests || !date || !branch) {
        timeSlotSelect.innerHTML = `<option value="" disabled selected>Please select all fields</option>`;
        return;
      }

      const params = new URLSearchParams({
        guests: guests,
        date: date,
        branch: branch
      });

      try {
        const res = await fetch(`/api/fetch_time_slots/?${params.toString()}`);
        const data = await res.json();

        timeSlotSelect.innerHTML = ''; // 清空選單

        if (!data.slots || data.slots.length === 0) {
          timeSlotSelect.innerHTML = `<option value="" disabled>No available time slots</option>`;
          return;
        }

        for (const slot of data.slots) {
          const option = document.createElement('option');
          option.value = slot.time;
          option.textContent = slot.display;
          if (!slot.available) {
            option.disabled = true;
            option.style.color = 'gray';
          }
          timeSlotSelect.appendChild(option);
        }

        // 預設選第一個可用時段
        const firstAvailable = [...timeSlotSelect.options].find(o => !o.disabled);
        if (firstAvailable) {
          timeSlotSelect.value = firstAvailable.value;
        }

      } catch (err) {
        console.error("Failed to load time slots:", err);
        timeSlotSelect.innerHTML = `<option value="" disabled>Error loading slots</option>`;
      }
    }

    // 綁定變更事件
    guestsInput.addEventListener('change', updateTimeSlots);
    dateInput.addEventListener('change', updateTimeSlots);
    branchInput.addEventListener('change', function () {
      updateTimeSlots();
    });

    // 頁面載入後也執行一次
    updateTimeSlots();
  });
</script>

{% endblock %}